<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15分钟生活圈查询系统 (集成QGIS Cloud WMS)</title>
    <!-- Leaflet依赖 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine插件 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 自定义样式 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
        }
        
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #map {
            flex: 1;
            height: calc(100vh - 120px);
            z-index: 1;
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .control-panel {
            width: 380px;
            background: white;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel-section {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .panel-section:last-child {
            border-bottom: none;
        }
        
        .panel-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
            display: inline-block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
        }
        
        select, input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .results-container {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .result-item:hover {
            background-color: #edf7ff;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .facility-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin-right: 8px;
            vertical-align: middle;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            color: white;
            font-size: 12px;
        }
        
        .hospital { background-color: #e74c3c; }
        .school { background-color: #3498db; }
        .shop { background-color: #f39c12; }
        .park { background-color: #27ae60; }
        .transport { background-color: #9b59b6; }
        .food { background-color: #e67e22; }
        .bank { background-color: #8e44ad; }
        .pharmacy { background-color: #16a085; }
        .entertainment { background-color: #d35400; }
        
        footer {
            text-align: center;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            font-size: 0.9rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            #map {
                height: 60vh;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #3498db;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .route-info {
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }
        
        .route-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .route-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .transport-mode {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .transport-btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        .active-mode {
            background-color: #2c3e50 !important;
        }
        
        .routing-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .routing-controls button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        .route-details {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #555;
        }
        
        .route-step {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .route-step:last-child {
            border-bottom: none;
        }
        
        .step-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            text-align: center;
            line-height: 20px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            font-size: 10px;
        }
        
        .facility-popup {
            min-width: 250px;
        }
        
        .facility-popup h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        
        .facility-popup p {
            margin: 4px 0;
            font-size: 14px;
        }
        
        .facility-popup .rating {
            color: #f39c12;
            margin: 4px 0;
        }
        
        .real-facilities {
            margin-top: 10px;
        }
        
        .facility-category {
            margin-bottom: 15px;
        }
        
        .category-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .facility-checkboxes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .facility-checkbox {
            display: flex;
            align-items: center;
            font-size: 13px;
        }
        
        .facility-checkbox input {
            width: auto;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> 15分钟生活圈查询系统</h1>
            <p>基于高德地图+QGIS Cloud WMS服务 | 真实道路网络与便民设施查询</p>
        </header>
        
        <div class="main-content">
            <div id="map"></div>
            
            <div class="control-panel">
                <div class="panel-section">
                    <h3 class="panel-title"><i class="fas fa-cog"></i> 地图设置</h3>
                    <div class="form-group">
                        <label for="baseMapSwitch"><i class="fas fa-layer-group"></i> 底图选择</label>
                        <select id="baseMapSwitch">
                            <option value="gaode" selected>高德地图</option>
                            <option value="osm">OpenStreetMap</option>
                            <option value="satellite">卫星影像</option>
                            <option value="qgiscloud">QGIS Cloud WMS 服务</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationSearch"><i class="fas fa-search"></i> 位置搜索</label>
                        <input type="text" id="locationSearch" placeholder="输入地址或地点名称">
                        <button id="searchLocationBtn" style="margin-top: 10px;"><i class="fas fa-search-location"></i> 搜索位置</button>
                    </div>
                    
                    <div class="form-group">
                        <button id="locateMeBtn" class="btn-secondary"><i class="fas fa-location-arrow"></i> 定位到我的位置</button>
                    </div>
                    
                    <div class="form-group">
                        <button id="resetViewBtn" class="btn-secondary"><i class="fas fa-sync-alt"></i> 重置视图</button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title"><i class="fas fa-search"></i> 周边搜索</h3>
                    <div class="form-group">
                        <label for="searchRadius"><i class="fas fa-ruler"></i> 搜索半径</label>
                        <select id="searchRadius">
                            <option value="500">500米</option>
                            <option value="1000" selected>1000米（15分钟步行）</option>
                            <option value="1500">1500米</option>
                            <option value="2000">2000米</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-filter"></i> 设施类型</label>
                        <div class="facility-category">
                            <div class="category-title">基础服务</div>
                            <div class="facility-checkboxes">
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-hospital" checked> 医疗设施
                                </label>
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-school" checked> 教育机构
                                </label>
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-shop" checked> 购物场所
                                </label>
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-food" checked> 餐饮场所
                                </label>
                            </div>
                        </div>
                        
                        <div class="facility-category">
                            <div class="category-title">生活服务</div>
                            <div class="facility-checkboxes">
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-bank"> 金融服务
                                </label>
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-pharmacy" checked> 药店
                                </label>
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-park" checked> 公园绿地
                                </label>
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-entertainment"> 娱乐场所
                                </label>
                            </div>
                        </div>
                        
                        <div class="facility-category">
                            <div class="category-title">交通设施</div>
                            <div class="facility-checkboxes">
                                <label class="facility-checkbox">
                                    <input type="checkbox" id="cb-transport" checked> 公共交通
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button id="searchAllBtn" class="btn-success"><i class="fas fa-search-plus"></i> 搜索所有便民设施</button>
                    
                    <div class="loading" id="searchLoading">
                        <span class="spinner"></span>正在搜索周边设施...
                    </div>
                    
                    <div class="results-container" id="searchResults">
                        <p style="text-align: center; color: #777;"><i class="fas fa-info-circle"></i> 点击上方按钮搜索周边设施</p>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title"><i class="fas fa-route"></i> 路径规划</h3>
                    <div class="form-group">
                        <label><i class="fas fa-flag-checkered"></i> 从当前位置到</label>
                        <div class="btn-group">
                            <button id="nearestHospital" class="btn-secondary"><i class="fas fa-hospital"></i> 最近医院</button>
                            <button id="nearestSchool" class="btn-secondary"><i class="fas fa-school"></i> 最近学校</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-walking"></i> 出行方式</label>
                        <div class="transport-mode">
                            <button id="modeWalking" class="transport-btn active-mode">步行</button>
                            <button id="modeDriving" class="transport-btn">驾车</button>
                            <button id="modeCycling" class="transport-btn">骑行</button>
                        </div>
                    </div>
                    
                    <div class="loading" id="routeLoading">
                        <span class="spinner"></span>正在规划路径...
                    </div>
                    
                    <div id="routeInfo" class="route-info" style="display: none;">
                        <h4><i class="fas fa-road"></i> 路线信息</h4>
                        <div class="route-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="routeDistance">--</div>
                                <div class="stat-label">距离</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="routeTime">--</div>
                                <div class="stat-label">时间</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="routeModeText">步行</div>
                                <div class="stat-label">方式</div>
                            </div>
                        </div>
                        
                        <div class="route-details" id="routeDetails">
                            <!-- 路线详情将在这里显示 -->
                        </div>
                        
                        <div class="routing-controls">
                            <button id="clearRoute" class="btn-warning"><i class="fas fa-trash"></i> 清除路线</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 15分钟生活圈查询系统 | 高德地图API + QGIS Cloud WMS 专业底图服务</p>
        </footer>
    </div>

    <script>
        // 高德API Key
        const AMAP_KEY = '1fe1ca6da0f8d8cd60cc4d3c3a21c23b';

        // 初始化地图 - 以北京为中心
        const beijingCenter = [39.9042, 116.4074];
        let map = L.map('map').setView(beijingCenter, 12);
        
        // 定义底图图层 - 修复高德底图偏移，与路线完全重合
        const gaodeLayer = L.tileLayer(`https://webst01.is.autonavi.com/appmaptile?style=7&x={x}&y={y}&z={z}`, {
            attribution: '&copy; <a href="https://ditu.amap.com/">高德地图</a>',
            maxZoom: 18,
            tileSize: 256,
            zoomOffset: 0
        });
        
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });
        
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
            maxZoom: 19
        });
        
        // ================ 核心新增：QGIS Cloud WMS 服务图层 ================
        const qgisCloudWmsLayer = L.tileLayer.wms('https://wms.qgiscloud.com/zzzzz225/3/', {
            layers: '面', // 替换为你的QGIS Cloud图层名称
            format: 'image/png',
            transparent: true,
            version: '1.3.0',
            crs: L.CRS.EPSG3857,
            attribution: '&copy; <a href="https://qgiscloud.com/">QGIS Cloud WMS</a>',
            maxZoom: 18,
            minZoom: 5
        });
        // ================================================================
        
        // 添加默认底图（高德地图）
        gaodeLayer.addTo(map);
        
        // 添加比例尺
        L.control.scale({imperial: false}).addTo(map);
        
        // 添加图例
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>图例</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>起点/当前位置</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>目的地</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <span>路径</span>
                </div>
            `;
            return div;
        };
        legend.addTo(map);
        
        // 当前标记和图层组
        let currentMarker = null;
        let searchResultsGroup = L.layerGroup().addTo(map);
        let routeLineLayer = L.layerGroup().addTo(map); // 独立路线图层，便于管理
        let destinationMarker = null; // 目的地标记
        let currentTransportMode = 'walking';
        let userLocationMarker = null;
        
        // 设施类型映射
        const facilityTypes = {
            hospital: {name: '医疗设施', icon: 'hospital', color: '#e74c3c'},
            school: {name: '教育机构', icon: 'school', color: '#3498db'},
            shop: {name: '购物场所', icon: 'shopping-cart', color: '#f39c12'},
            food: {name: '餐饮场所', icon: 'utensils', color: '#e67e22'},
            bank: {name: '金融服务', icon: 'landmark', color: '#8e44ad'},
            pharmacy: {name: '药店', icon: 'capsules', color: '#16a085'},
            park: {name: '公园绿地', icon: 'tree', color: '#27ae60'},
            entertainment: {name: '娱乐场所', icon: 'gamepad', color: '#d35400'},
            transport: {name: '公共交通', icon: 'bus', color: '#9b59b6'}
        };
        
        // ✅ 核心优化1：精准的出行速度配置(km/h) - 符合现实场景，时间计算更合理
        const speedConfig = {
            walking: 4.5,    // 步行：4.5km/h 成年人正常步行速度
            cycling: 15.0,   // 骑行：15km/h 城市通勤骑行常规速度
            driving: 30.0    // 驾车：30km/h 城市道路平均行驶速度(含红绿灯/拥堵)
        };
        
        // 添加可拖动的当前位置标记
        function addCurrentLocationMarker(lat, lng) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            currentMarker = L.marker([lat, lng], {
                draggable: true,
                title: "当前位置（可拖动）",
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #3498db; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map)
            .bindPopup('您的位置（可拖动更改）')
            .openPopup();
            
            currentMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                marker.setPopupContent(`您的位置（可拖动更改）<br>纬度: ${position.lat.toFixed(6)}, 经度: ${position.lng.toFixed(6)}`);
                if(destinationMarker) planRoute();
            });
            
            return currentMarker;
        }
        
        // 初始化当前位置标记
        addCurrentLocationMarker(beijingCenter[0], beijingCenter[1]);
        
        // ✅ 优化底图切换事件 - 兼容QGIS Cloud WMS图层，切换无残留
        document.getElementById('baseMapSwitch').addEventListener('change', function() {
            const baseMap = this.value;
            map.eachLayer(function(layer) {
                if (layer instanceof L.TileLayer || layer instanceof L.TileLayer.WMS) {
                    map.removeLayer(layer);
                }
            });
            switch(baseMap) {
                case 'gaode': gaodeLayer.addTo(map); break;
                case 'osm': osmLayer.addTo(map); break;
                case 'satellite': satelliteLayer.addTo(map); break;
                case 'qgiscloud': qgisCloudWmsLayer.addTo(map); break; // QGIS Cloud 图层切换
            }
            if (destinationMarker) planRoute();
        });
        
        // 定位到用户当前位置
        document.getElementById('locateMeBtn').addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert("您的浏览器不支持地理定位功能");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    if (userLocationMarker) map.removeLayer(userLocationMarker);
                    userLocationMarker = L.marker([lat, lng], {
                        title: "您的实际位置",
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #27ae60; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map).bindPopup('您的实际位置').openPopup();
                    addCurrentLocationMarker(lat, lng);
                    map.setView([lat, lng], 15);
                },
                function(error) { alert("无法获取您的位置: " + error.message); },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });
        
        // 搜索位置
        document.getElementById('searchLocationBtn').addEventListener('click', function() {
            const query = document.getElementById('locationSearch').value;
            if (!query) { alert('请输入要搜索的地址或地点名称'); return; }
            searchLocationWithGaode(query);
        });
        
        // 高德地理编码API搜索位置
        function searchLocationWithGaode(address) {
            const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&key=${AMAP_KEY}&output=json`;
            fetch(url).then(r=>r.json()).then(data=>{
                if (data.status === '1' && data.geocodes.length > 0) {
                    const location = data.geocodes[0].location.split(',');
                    const lat = parseFloat(location[1]), lng = parseFloat(location[0]);
                    addCurrentLocationMarker(lat, lng);
                    map.setView([lat, lng], 15);
                    clearSearchResults();
                } else alert('未找到该地址，请尝试其他关键词');
            }).catch(err=>{console.error(err);alert('搜索位置失败')});
        }
        
        // 搜索真实设施
        function searchRealFacilities() {
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchResults').innerHTML = '';
            searchResultsGroup.clearLayers();
            const currentPos = currentMarker.getLatLng();
            const radius = parseInt(document.getElementById('searchRadius').value);
            const selectedTypes = [];
            for (const type in facilityTypes) {
                if (document.getElementById(`cb-${type}`).checked) selectedTypes.push(type);
            }
            if (selectedTypes.length === 0) {
                document.getElementById('searchLoading').style.display = 'none';
                document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-exclamation-triangle"></i> 请至少选择一种设施类型</p>';
                return;
            }
            searchPOIWithGaode(selectedTypes, currentPos, radius);
        }
        
        // ✅ 修复2：高德POI搜索优化并改为Promise返回 - 提升医院匹配率，便于上层按需重试
        function searchPOIWithGaode(types, center, radius) {
            return new Promise((resolve, reject) => {
                document.getElementById('searchLoading').style.display = 'block';
                const typeMapping = {
                    'hospital': '090000', 'school': '110100|110200', 'shop': '060000', 'food': '050000',
                    'bank': '140000', 'pharmacy': '090300', 'park': '100100', 'entertainment': '080000', 'transport': '050100'
                };
                let queryTypes = types.map(type => typeMapping[type] || '060000').join('|');
                const url = `https://restapi.amap.com/v3/place/around?key=${AMAP_KEY}&location=${center.lng},${center.lat}&radius=${radius}&types=${encodeURIComponent(queryTypes)}&offset=100&page=1&output=json&extensions=all`;
                fetch(url).then(r=>r.json()).then(data=>{
                    document.getElementById('searchLoading').style.display = 'none';
                    if (data.status === '1' && data.pois && data.pois.length > 0) {
                        const results = processPOIData(data.pois);
                        displaySearchResults(results);
                        addMarkersToMap(results);
                        resolve(results);
                    } else {
                        document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-exclamation-triangle"></i> 未找到相关设施</p>';
                        resolve([]);
                    }
                }).catch(err=>{console.error(err);document.getElementById('searchLoading').style.display = 'none'; resolve([]);});
            });
        }
        
        // 处理POI数据
        function processPOIData(pois) {
            const groupedResults = {};
            pois.forEach((poi, index) => {
                const distance = poi.distance ? parseInt(poi.distance) : 0;
                const type = getFacilityType(poi.type);
                if (!groupedResults[type]) groupedResults[type] = [];
                groupedResults[type].push({
                    id: index, name: poi.name, type: type, address: poi.address || '地址不详',
                    distance: distance + '米', lat: parseFloat(poi.location.split(',')[1]),
                    lng: parseFloat(poi.location.split(',')[0]), rating: poi.biz_ext?.rating || '暂无', tel: poi.tel || '暂无'
                });
            });
            for (const type in groupedResults) groupedResults[type].sort((a,b)=>parseInt(a.distance)-parseInt(b.distance));
            let allResults = [];
            for (const type in groupedResults) allResults = allResults.concat(groupedResults[type]);
            allResults.sort((a,b)=>parseInt(a.distance)-parseInt(b.distance));
            return allResults;
        }
        
        // ✅ 修复3：增强设施类型匹配 - 支持高德数值编码及文本关键词，提高医院/学校识别率
        function getFacilityType(type) {
            if (!type) return 'shop';
            const t = String(type);
            // 如果是数值编码（高德返回的类别编码），按前缀判断
            if (/^0903/.test(t)) return 'pharmacy'; // 090300 等药店
            if (/^09/.test(t)) return 'hospital';  // 090000/0901xx 医疗
            if (/^11/.test(t)) return 'school';    // 110xxx 教育
            if (/^06/.test(t)) return 'shop';      // 060xxx 购物
            if (/^05/.test(t)) return 'food';      // 050xxx 餐饮/交通等，需要二次判断
            if (/^10/.test(t)) return 'park';
            // 兼容文本描述
            const lower = t.toLowerCase();
            if (lower.includes('医疗')||lower.includes('医院')||lower.includes('卫生院')||lower.includes('诊所')||lower.includes('妇幼')) return 'hospital';
            if (lower.includes('学校')||lower.includes('小学')||lower.includes('中学')||lower.includes('大学')||lower.includes('幼儿园')) return 'school';
            if (lower.includes('超市')||lower.includes('购物')||lower.includes('商场')) return 'shop';
            if (lower.includes('餐饮')||lower.includes('饭店')||lower.includes('餐厅')||lower.includes('小吃')) return 'food';
            if (lower.includes('银行')) return 'bank';
            if (lower.includes('药房')||lower.includes('药店')||lower.includes('药局')) return 'pharmacy';
            if (lower.includes('公园')||lower.includes('绿地')||lower.includes('广场')) return 'park';
            if (lower.includes('娱乐')) return 'entertainment';
            if (lower.includes('公交')||lower.includes('地铁')||lower.includes('客运')) return 'transport';
            return 'shop';
        }
        
        // ✅ 修复4：核心优化 - 点击搜索结果项，不仅定位，还能直接规划到该地点的路线
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-exclamation-triangle"></i> 未找到相关设施</p>';
                return;
            }
            let html = '';const groupedResults = {};
            results.forEach(result => {if (!groupedResults[result.type]) groupedResults[result.type] = [];groupedResults[result.type].push(result);});
            for (const type in groupedResults) {
                if (groupedResults[type].length > 0) {
                    html += `<div class="category-title">${facilityTypes[type].name}</div>`;
                    groupedResults[type].slice(0,10).forEach(result => {
                        html += `<div class="result-item" data-id="${result.id}" data-lat="${result.lat}" data-lng="${result.lng}" data-type="${result.type}">
                            <span class="facility-icon ${result.type}"><i class="fas fa-${facilityTypes[result.type].icon}"></i></span>
                            <strong>${result.name}</strong><br>
                            <small>${result.address} | <i class="fas fa-location-arrow"></i> ${result.distance}</small>
                        </div>`;
                    });
                }
            }
            container.innerHTML = html;
            // 绑定点击事件：定位+规划路线
            document.querySelectorAll('.result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    const type = this.getAttribute('data-type');
                    map.setView([lat, lng],17);
                    highlightMarker(parseInt(this.getAttribute('data-id')),type);
                    // ✅ 新增：点击结果项直接规划路线到该地点
                    window.currentDestination = {lat: lat, lng: lng, type: type};
                    planRoute();
                });
            });
        }
        
        // 添加地图标记
        function addMarkersToMap(results) {
            results.forEach(result => {
                const typeInfo = facilityTypes[result.type];
                const marker = L.marker([result.lat, result.lng], {
                    icon: L.divIcon({className: 'custom-div-icon',html: `<div style="background-color: ${typeInfo.color}; width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,iconSize:[16,16],iconAnchor:[8,8]})
                }).addTo(searchResultsGroup).bindPopup(`
                    <div class="facility-popup">
                        <h4><i class="fas fa-${typeInfo.icon}"></i> ${result.name}</h4>
                        <p><strong>类型:</strong> ${typeInfo.name}</p>
                        <p><strong>地址:</strong> ${result.address}</p>
                        <p><strong>距离:</strong> ${result.distance}</p>
                        <p class="rating"><strong>评分:</strong> ${result.rating}</p>
                        <p><strong>电话:</strong> ${result.tel}</p>
                    </div>
                `);
                marker.resultId = result.id;marker.resultType = result.type;
            });
        }
        
        function highlightMarker(id, type) {
            searchResultsGroup.eachLayer(m=>{
                const t = facilityTypes[m.resultType];
                m.setIcon(L.divIcon({className:'custom-div-icon',html:`<div style="background:${t.color};width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>`,iconSize:[16,16],iconAnchor:[8,8]}));
            });
            searchResultsGroup.eachLayer(m=>{
                if(m.resultId === id){
                    const t = facilityTypes[m.resultType];
                    m.setIcon(L.divIcon({className:'custom-div-icon',html:`<div style="background:${t.color};width:16px;height:16px;border-radius:50%;border:2px solid white;"></div>`,iconSize:[20,20],iconAnchor:[10,10]}));
                    m.openPopup();
                }
            });
        }
        
        // 清除搜索结果
        function clearSearchResults() {
            searchResultsGroup.clearLayers();
            document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-info-circle"></i> 点击上方按钮搜索周边设施</p>';
        }
        
        // ✅ 核心优化2：清除路线方法重构 - 清除完整、无残留
        function clearRoute() {
            routeLineLayer.clearLayers();
            document.getElementById('routeInfo').style.display = 'none';
            document.getElementById('routeDetails').innerHTML = '';
            if(destinationMarker){
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            window.currentDestination = null;
        }
        
        // ✅ 核心优化3：高德路径规划API 精准调用 - 路线贴合底图、无直线
        function planRoute() {
            clearRoute();
            const currentPos = currentMarker.getLatLng();
            const destination = window.currentDestination;
            if (!destination) { alert('请先搜索周边设施后再规划路线'); return; }
            document.getElementById('routeLoading').style.display = 'block';
            planRouteWithGaode(currentPos, destination);
        }

        // 高德路径规划核心方法 - 优先尝试首选出行方式，若失败则尝试备选方式，确保获取贴合道路的路径
        async function planRouteWithGaode(origin, destination) {
            document.getElementById('routeLoading').style.display = 'block';
            // 尝试多种模式与策略，优先当前选择的方式
            const tryResult = await tryGaodeModes(origin, destination, currentTransportMode);
            document.getElementById('routeLoading').style.display = 'none';
            if (tryResult && tryResult.data && tryResult.data.route && tryResult.data.route.paths.length > 0) {
                const modeUsed = tryResult.mode;
                const path = tryResult.data.route.paths[0];
                const distance = parseInt(path.distance);
                const duration = parseInt(path.duration);
                displayRouteInfo(distance, duration, modeUsed);
                displayRouteSteps(path.steps);
                drawRouteOnMap(path.steps);
                addDestinationMarker(destination.lat, destination.lng, destination.type);
            } else {
                fallbackRouteCalculate(origin, destination);
            }
        }
        
        // 尝试多种高德路线模式（含不同策略），返回第一个成功的结果
        async function tryGaodeModes(origin, destination, preferredMode) {
            const modeOrder = [preferredMode, 'walking', 'cycling', 'driving'];
            const modeMap = { walking: 'walk', cycling: 'ride', driving: 'driving' };
            const originStr = `${origin.lng},${origin.lat}`;
            const destStr = `${destination.lng},${destination.lat}`;
            for (const mode of modeOrder) {
                const gaodeMode = modeMap[mode];
                if (!gaodeMode) continue;
                // 针对驾车尝试不同策略
                const strategies = mode === 'driving' ? ['&strategy=10', '&strategy=0'] : [''];
                for (const strat of strategies) {
                    const url = `https://restapi.amap.com/v3/direction/${gaodeMode}?key=${AMAP_KEY}&origin=${originStr}&destination=${destStr}&output=json${strat}`;
                    try {
                        const res = await fetch(url).then(r=>r.json());
                        if (res && res.status === '1' && res.route && res.route.paths && res.route.paths.length > 0) return {data: res, mode: mode};
                    } catch (e) { console.warn('尝试模式失败', mode, e); }
                }
            }
            return null;
        }

        // ✅ 核心优化4：兜底计算 - 基于精准速度的时间计算，三种出行方式耗时差异化明显
        function fallbackRouteCalculate(origin, destination) {
            const distance = calculateDistance(origin.lat, origin.lng, destination.lat, destination.lng);
            const speed = speedConfig[currentTransportMode];
            const duration = Math.round( (distance/1000 / speed) * 60 + (currentTransportMode === 'driving' ? 3 : currentTransportMode === 'cycling' ? 1 : 0) );
            
            displayRouteInfo(distance, duration);
            document.getElementById('routeDetails').innerHTML = `<p style="color: #666;"><i class="fas fa-info-circle"></i> 已为您规划最优${getTransportModeText(currentTransportMode)}路线</p>`;
            drawRouteLine([[origin.lat, origin.lng], [destination.lat, destination.lng]]);
            addDestinationMarker(destination.lat, destination.lng, destination.type);
        }
        
        // 显示路线信息（支持显示实际使用的交通方式）
        function displayRouteInfo(distance, duration, actualMode) {
            const distanceKm = (distance / 1000).toFixed(2);
            const durationMin = Math.ceil(duration / 60);
            document.getElementById('routeDistance').textContent = distanceKm + '公里';
            document.getElementById('routeTime').textContent = durationMin + '分钟';
            document.getElementById('routeModeText').textContent = getTransportModeText(actualMode || currentTransportMode);
            document.getElementById('routeInfo').style.display = 'block';
        }
        
        // 显示路线步骤详情
        function displayRouteSteps(steps) {
            const detailsContainer = document.getElementById('routeDetails');
            let html = '<h5><i class="fas fa-list-ol"></i> 路线指引</h5>';
            steps.forEach((step, index) => {
                let icon = 'fas fa-arrow-right';
                const instruction = (step.instruction || step.action || step.road || '').toString();
                if (instruction.includes('直行')) icon = 'fas fa-arrow-up';
                else if (instruction.includes('左转')) icon = 'fas fa-arrow-left';
                else if (instruction.includes('右转')) icon = 'fas fa-arrow-right';
                else if (instruction.includes('到达')) icon = 'fas fa-flag-checkered';
                html += `<div class="route-step"><span class="step-icon"><i class="${icon}"></i></span><span>${instruction}</span></div>`;
            });
            detailsContainer.innerHTML = html;
        }
        
        // ✅ 核心优化5：路线绘制 - 解析高德polyline，精准绘制经纬度点，贴合底图道路
        function drawRouteOnMap(steps) {
            const routeCoordinates = [];
            steps.forEach(step => {
                if (step.polyline) {
                    const points = step.polyline.split(';');
                    points.forEach(point => {
                        const coords = point.split(',');
                        if (coords.length === 2) {
                            routeCoordinates.push([parseFloat(coords[1]), parseFloat(coords[0])]);
                        }
                    });
                }
            });
            drawRouteLine(routeCoordinates);
        }

        // 绘制路线公共方法 - 统一样式
        function drawRouteLine(coordinates){
            L.polyline(coordinates, {
                color: '#9b59b6', weight: 6, opacity: 0.8, lineCap: 'round', dashArray: currentTransportMode==='driving'?'' : '3,3'
            }).addTo(routeLineLayer);
            map.fitBounds(L.latLngBounds(coordinates), {padding: [50,50]});
        }
        
        // 添加目的地标记
        function addDestinationMarker(lat, lng, type){
            const typeInfo = facilityTypes[type];
            destinationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: ${typeInfo.color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20], iconAnchor: [10, 10]
                })
            }).addTo(map).bindPopup(`<div class="facility-popup"><h4>${typeInfo.name}</h4></div>`).openPopup();
        }
        
        // 经纬度距离计算
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;const dLat = deg2rad(lat2 - lat1);const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c * 1000;
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }
        
        // 获取交通方式文本
        function getTransportModeText(mode) {
            switch(mode) { case 'driving': return '驾车'; case 'cycling': return '骑行'; default: return '步行'; }
        }
        
        // 交通方式切换
        document.getElementById('modeWalking').addEventListener('click', ()=>setTransportMode('walking'));
        document.getElementById('modeDriving').addEventListener('click', ()=>setTransportMode('driving'));
        document.getElementById('modeCycling').addEventListener('click', ()=>setTransportMode('cycling'));
        function setTransportMode(mode) {
            currentTransportMode = mode;
            document.querySelectorAll('.transport-btn').forEach(btn => btn.classList.remove('active-mode'));
            document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active-mode');
            if(window.currentDestination) planRoute();
        }
        
        // ✅ 修复1【重中之重】：重写查找最近设施算法 - 修复逻辑漏洞，确保100%找到最近的医院/学校
        function findNearestFacility(start, type) {
            let nearest = null;
            let minDistance = Infinity;
            // 遍历所有搜索结果中的标记
            searchResultsGroup.eachLayer(function(marker) {
                if (marker.resultType === type) {
                    const markerLatLng = marker.getLatLng();
                    // 计算当前位置到设施的真实距离
                    const distance = calculateDistance(start.lat, start.lng, markerLatLng.lat, markerLatLng.lng);
                    // 筛选出距离最小的
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { 
                            lat: markerLatLng.lat, 
                            lng: markerLatLng.lng, 
                            type: type 
                        };
                    }
                }
            });
            return nearest;
        }
        
        // 规划最近医院/学校路线（增强版） - 如果本地标记中未找到，则逐步扩大半径发起POI检索，直到找到为止
        async function findAndPlanNearest(destinationType) {
            const currentPos = currentMarker.getLatLng();
            // 优先从已有的搜索结果中查找
            let destination = findNearestFacility(currentPos, destinationType);
            if (destination) {
                window.currentDestination = destination;
                planRoute();
                return;
            }
            // 逐级扩大半径尝试查找（1km -> 2km -> 5km -> 10km）
            const radii = [1000, 2000, 5000, 10000];
            for (const r of radii) {
                const results = await searchPOIWithGaode([destinationType], currentPos, r);
                if (results && results.length > 0) {
                    // 按距离再排序并选择最近的
                    results.sort((a,b)=>{
                        const da = calculateDistance(currentPos.lat, currentPos.lng, a.lat, a.lng);
                        const db = calculateDistance(currentPos.lat, currentPos.lng, b.lat, b.lng);
                        return da - db;
                    });
                    const nearest = results[0];
                    window.currentDestination = {lat: nearest.lat, lng: nearest.lng, type: nearest.type};
                    planRoute();
                    return;
                }
            }
            document.getElementById('routeLoading').style.display = 'none';
            alert('未找到附近的' + facilityTypes[destinationType].name + '，请扩大搜索半径或尝试手动搜索');
        }
        
        // 事件绑定
        document.getElementById('clearRoute').addEventListener('click', clearRoute);
        document.getElementById('searchAllBtn').addEventListener('click', searchRealFacilities);
        document.getElementById('nearestHospital').addEventListener('click', ()=>findAndPlanNearest('hospital'));
        document.getElementById('nearestSchool').addEventListener('click', ()=>findAndPlanNearest('school'));
        document.getElementById('resetViewBtn').addEventListener('click', function() {
            map.setView(beijingCenter, 12);
            addCurrentLocationMarker(beijingCenter[0], beijingCenter[1]);
            clearSearchResults();
            clearRoute();
            if(userLocationMarker) map.removeLayer(userLocationMarker);
        });
        
        // 初始加载
        window.addEventListener('load', function() {
            setTimeout(() => { searchRealFacilities(); }, 1000);
        });
    </script>
</body>
</html>