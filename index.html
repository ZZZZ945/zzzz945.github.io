<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15分钟生活圈查询系统</title>
    <!-- Leaflet依赖 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine插件 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <!-- Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 自定义样式 -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
        }
        
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        #map {
            flex: 1;
            height: calc(100vh - 120px);
            z-index: 1;
            border-radius: 4px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        
        .control-panel {
            width: 380px;
            background: white;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel-section {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        
        .panel-section:last-child {
            border-bottom: none;
        }
        
        .panel-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
            display: inline-block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
        }
        
        select, input, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-success {
            background-color: #27ae60;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .results-container {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
        }
        
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .result-item:hover {
            background-color: #edf7ff;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .facility-icon {
            display: inline-block;
            width: 24px;
            height: 24px;
            margin-right: 8px;
            vertical-align: middle;
            border-radius: 50%;
            text-align: center;
            line-height: 24px;
            color: white;
            font-size: 12px;
        }
        
        .hospital { background-color: #e74c3c; }
        .school { background-color: #3498db; }
        .shop { background-color: #f39c12; }
        .park { background-color: #27ae60; }
        .transport { background-color: #9b59b6; }
        
        footer {
            text-align: center;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            font-size: 0.9rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            #map {
                height: 60vh;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #3498db;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .route-info {
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }
        
        .route-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .route-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .transport-mode {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .transport-btn {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        .active-mode {
            background-color: #2c3e50 !important;
        }
        
        .routing-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .routing-controls button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
        }
        
        .route-details {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #555;
        }
        
        .route-step {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .route-step:last-child {
            border-bottom: none;
        }
        
        .step-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            text-align: center;
            line-height: 20px;
            background-color: #3498db;
            color: white;
            border-radius: 50%;
            font-size: 10px;
        }
        
        .facility-popup {
            min-width: 250px;
        }
        
        .facility-popup h4 {
            margin: 0 0 8px 0;
            color: #2c3e50;
        }
        
        .facility-popup p {
            margin: 4px 0;
            font-size: 14px;
        }
        
        .facility-popup .rating {
            color: #f39c12;
            margin: 4px 0;
        }
        
        .real-facilities {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-map-marked-alt"></i> 15分钟生活圈查询系统</h1>
            <p>基于高德地图的真实道路网络与便民设施查询</p>
        </header>
        
        <div class="main-content">
            <div id="map"></div>
            
            <div class="control-panel">
                <div class="panel-section">
                    <h3 class="panel-title"><i class="fas fa-cog"></i> 地图设置</h3>
                    <div class="form-group">
                        <label for="baseMapSwitch"><i class="fas fa-layer-group"></i> 底图选择</label>
                        <select id="baseMapSwitch">
                            <option value="gaode" selected>高德地图</option>
                            <option value="osm">OpenStreetMap</option>
                            <option value="satellite">卫星影像</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationSearch"><i class="fas fa-search"></i> 位置搜索</label>
                        <input type="text" id="locationSearch" placeholder="输入地址或地点名称">
                        <button id="searchLocationBtn" style="margin-top: 10px;"><i class="fas fa-search-location"></i> 搜索位置</button>
                    </div>
                    
                    <div class="form-group">
                        <button id="locateMeBtn" class="btn-secondary"><i class="fas fa-location-arrow"></i> 定位到我的位置</button>
                    </div>
                    
                    <div class="form-group">
                        <button id="resetViewBtn" class="btn-secondary"><i class="fas fa-sync-alt"></i> 重置视图</button>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title"><i class="fas fa-search"></i> 周边搜索</h3>
                    <div class="form-group">
                        <label for="searchRadius"><i class="fas fa-ruler"></i> 搜索半径</label>
                        <select id="searchRadius">
                            <option value="500">500米</option>
                            <option value="1000" selected>1000米（15分钟步行）</option>
                            <option value="1500">1500米</option>
                            <option value="2000">2000米</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-filter"></i> 设施类型</label>
                        <div class="btn-group">
                            <button id="searchHospitals" class="btn-secondary"><i class="fas fa-hospital"></i> 医疗</button>
                            <button id="searchSchools" class="btn-secondary"><i class="fas fa-school"></i> 教育</button>
                            <button id="searchShops" class="btn-secondary"><i class="fas fa-shopping-cart"></i> 购物</button>
                        </div>
                    </div>
                    
                    <button id="searchAllBtn" class="btn-success"><i class="fas fa-search-plus"></i> 搜索所有便民设施</button>
                    
                    <div class="loading" id="searchLoading">
                        <span class="spinner"></span>正在搜索周边设施...
                    </div>
                    
                    <div class="results-container" id="searchResults">
                        <p style="text-align: center; color: #777;"><i class="fas fa-info-circle"></i> 点击上方按钮搜索周边设施</p>
                    </div>
                </div>
                
                <div class="panel-section">
                    <h3 class="panel-title"><i class="fas fa-route"></i> 路径规划</h3>
                    <div class="form-group">
                        <label><i class="fas fa-flag-checkered"></i> 从当前位置到</label>
                        <div class="btn-group">
                            <button id="nearestHospital" class="btn-secondary"><i class="fas fa-hospital"></i> 最近医院</button>
                            <button id="nearestSchool" class="btn-secondary"><i class="fas fa-school"></i> 最近学校</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-walking"></i> 出行方式</label>
                        <div class="transport-mode">
                            <button id="modeWalking" class="transport-btn active-mode">步行</button>
                            <button id="modeDriving" class="transport-btn">驾车</button>
                            <button id="modeCycling" class="transport-btn">骑行</button>
                        </div>
                    </div>
                    
                    <div class="loading" id="routeLoading">
                        <span class="spinner"></span>正在规划路径...
                    </div>
                    
                    <div id="routeInfo" class="route-info" style="display: none;">
                        <h4><i class="fas fa-road"></i> 路线信息</h4>
                        <div class="route-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="routeDistance">--</div>
                                <div class="stat-label">距离</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="routeTime">--</div>
                                <div class="stat-label">时间</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="routeModeText">步行</div>
                                <div class="stat-label">方式</div>
                            </div>
                        </div>
                        
                        <div class="route-details" id="routeDetails">
                            <!-- 路线详情将在这里显示 -->
                        </div>
                        
                        <div class="routing-controls">
                            <button id="clearRoute" class="btn-warning"><i class="fas fa-trash"></i> 清除路线</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 15分钟生活圈查询系统 | 基于高德地图API的真实道路网络</p>
        </footer>
    </div>

    <script>
        // 高德API Key
        const AMAP_KEY = '1fe1ca6da0f8d8cd60cc4d3c3a21c23b';

        // 初始化地图 - 以北京为中心
        const beijingCenter = [39.9042, 116.4074];
        let map = L.map('map').setView(beijingCenter, 12);
        
        // 定义底图图层
        const gaodeLayer = L.tileLayer(`https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}&key=${AMAP_KEY}`, {
            attribution: '&copy; <a href="https://ditu.amap.com/">高德地图</a>',
            maxZoom: 18,
            tileSize: 256,
            zoomOffset: 0
        });
        
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });
        
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.esri.com/">Esri</a>',
            maxZoom: 19
        });
        
        // 添加默认底图（高德地图）
        gaodeLayer.addTo(map);
        
        // 添加比例尺
        L.control.scale({imperial: false}).addTo(map);
        
        // 添加图例
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>图例</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>起点/当前位置</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>目的地</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <span>路径</span>
                </div>
            `;
            return div;
        };
        legend.addTo(map);
        
        // 当前标记和图层组
        let currentMarker = null;
        let searchResultsGroup = L.layerGroup().addTo(map);
        let routingControl = null;
        let currentTransportMode = 'walking';
        let userLocationMarker = null;
        
        // 添加可拖动的当前位置标记
        function addCurrentLocationMarker(lat, lng) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            currentMarker = L.marker([lat, lng], {
                draggable: true,
                title: "当前位置（可拖动）",
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #3498db; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map)
            .bindPopup('您的位置（可拖动更改）')
            .openPopup();
            
            currentMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                marker.setPopupContent(`您的位置（可拖动更改）<br>纬度: ${position.lat.toFixed(6)}, 经度: ${position.lng.toFixed(6)}`);
                
                if (routingControl) {
                    planRoute();
                }
            });
            
            return currentMarker;
        }
        
        // 初始化当前位置标记
        addCurrentLocationMarker(beijingCenter[0], beijingCenter[1]);
        
        // 底图切换
        document.getElementById('baseMapSwitch').addEventListener('change', function() {
            const baseMap = this.value;
            map.eachLayer(function(layer) {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            
            // 根据选择的底图重新初始化路由服务
            switch(baseMap) {
                case 'gaode':
                    gaodeLayer.addTo(map);
                    // 高德地图使用自己的路径规划服务
                    break;
                case 'osm':
                    osmLayer.addTo(map);
                    break;
                case 'satellite':
                    satelliteLayer.addTo(map);
                    break;
            }
            
            if (routingControl) {
                planRoute();
            }
        });
        
        // 定位到用户当前位置
        document.getElementById('locateMeBtn').addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert("您的浏览器不支持地理定位功能");
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    if (userLocationMarker) {
                        map.removeLayer(userLocationMarker);
                    }
                    
                    userLocationMarker = L.marker([lat, lng], {
                        title: "您的实际位置",
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #27ae60; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3);"></div>`,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    }).addTo(map)
                    .bindPopup('您的实际位置')
                    .openPopup();
                    
                    addCurrentLocationMarker(lat, lng);
                    map.setView([lat, lng], 15);
                },
                function(error) {
                    alert("无法获取您的位置: " + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
        
        // 搜索位置
        document.getElementById('searchLocationBtn').addEventListener('click', function() {
            const query = document.getElementById('locationSearch').value;
            if (!query) {
                alert('请输入要搜索的地址或地点名称');
                return;
            }
            
            // 使用高德地理编码API
            searchLocationWithGaode(query);
        });
        
        // 使用高德地理编码API搜索位置
        function searchLocationWithGaode(address) {
            const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&key=${AMAP_KEY}&output=json`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                        const location = data.geocodes[0].location.split(',');
                        const lat = parseFloat(location[1]);
                        const lng = parseFloat(location[0]);
                        
                        // 更新当前位置
                        addCurrentLocationMarker(lat, lng);
                        map.setView([lat, lng], 15);
                        
                        // 清除之前的搜索结果
                        clearSearchResults();
                    } else {
                        alert('未找到该地址，请尝试其他关键词');
                    }
                })
                .catch(error => {
                    console.error('搜索位置失败:', error);
                    alert('搜索位置失败，请检查网络连接');
                });
        }
        
        // 模拟搜索功能 - 现在使用真实的北京设施数据
        function searchRealFacilities(facilityType) {
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('searchResults').innerHTML = '';
            searchResultsGroup.clearLayers();
            
            const currentPos = currentMarker.getLatLng();
            const radius = parseInt(document.getElementById('searchRadius').value);
            
            // 使用高德POI搜索API
            searchPOIWithGaode(facilityType, currentPos, radius);
        }
        
        // 使用高德POI搜索API
        function searchPOIWithGaode(type, center, radius) {
            // 高德POI类型映射
            const typeMapping = {
                'hospital': '医疗保健服务',
                'school': '科教文化服务',
                'shop': '购物服务',
                'all': '商务住宅|医疗保健服务|科教文化服务|购物服务|体育休闲服务|餐饮服务'
            };
            
            const amapType = typeMapping[type] || typeMapping['all'];
            const url = `https://restapi.amap.com/v3/place/around?key=${AMAP_KEY}&location=${center.lng},${center.lat}&radius=${radius}&types=${encodeURIComponent(amapType)}&offset=20&page=1&output=json`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('searchLoading').style.display = 'none';
                    
                    if (data.status === '1' && data.pois && data.pois.length > 0) {
                        const results = processPOIData(data.pois);
                        displaySearchResults(results);
                        addMarkersToMap(results);
                    } else {
                        document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-exclamation-triangle"></i> 未找到相关设施</p>';
                    }
                })
                .catch(error => {
                    console.error('搜索设施失败:', error);
                    document.getElementById('searchLoading').style.display = 'none';
                    document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-exclamation-triangle"></i> 搜索失败，请稍后重试</p>';
                });
        }
        
        // 处理POI数据
        function processPOIData(pois) {
            return pois.map((poi, index) => {
                const distance = poi.distance ? parseInt(poi.distance) : 0;
                return {
                    id: index,
                    name: poi.name,
                    type: getFacilityIcon(poi.type),
                    address: poi.address || poi.district || '地址不详',
                    distance: distance + '米',
                    lat: parseFloat(poi.location.split(',')[1]),
                    lng: parseFloat(poi.location.split(',')[0]),
                    rating: poi.biz_ext ? poi.biz_ext.rating || '暂无' : '暂无',
                    tel: poi.tel || '暂无'
                };
            }).sort((a, b) => parseInt(a.distance) - parseInt(b.distance));
        }
        
        // 根据POI类型获取图标
        function getFacilityIcon(type) {
            if (type.includes('医疗保健')) return 'hospital';
            if (type.includes('教育') || type.includes('培训') || type.includes('学校')) return 'school';
            if (type.includes('购物') || type.includes('商场') || type.includes('超市')) return 'shopping-cart';
            if (type.includes('餐饮') || type.includes('美食')) return 'utensils';
            if (type.includes('娱乐') || type.includes('体育')) return 'gamepad';
            return 'store';
        }
        
        // 显示搜索结果
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-exclamation-triangle"></i> 未找到相关设施</p>';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                html += `
                <div class="result-item" data-id="${result.id}" data-lat="${result.lat}" data-lng="${result.lng}">
                    <span class="facility-icon ${result.type}"><i class="fas fa-${result.type}"></i></span>
                    <strong>${result.name}</strong><br>
                    <small>${result.address} | <i class="fas fa-location-arrow"></i> ${result.distance}</small>
                </div>
                `;
            });
            
            container.innerHTML = html;
            
            document.querySelectorAll('.result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const lat = parseFloat(this.getAttribute('data-lat'));
                    const lng = parseFloat(this.getAttribute('data-lng'));
                    map.setView([lat, lng], 17);
                    highlightMarker(parseInt(this.getAttribute('data-id')));
                });
            });
        }
        
        // 在地图上添加标记
        function addMarkersToMap(results) {
            results.forEach(result => {
                const marker = L.marker([result.lat, result.lng]).addTo(searchResultsGroup)
                    .bindPopup(`
                        <div class="facility-popup">
                            <h4><i class="fas fa-${result.type}"></i> ${result.name}</h4>
                            <p><strong>类型:</strong> ${getFacilityName(result.type)}</p>
                            <p><strong>地址:</strong> ${result.address}</p>
                            <p><strong>距离:</strong> ${result.distance}</p>
                            <p class="rating"><strong>评分:</strong> ${result.rating}</p>
                            <p><strong>电话:</strong> ${result.tel}</p>
                        </div>
                    `);
                
                marker.resultId = result.id;
            });
        }
        
        // 高亮显示选中的标记
        function highlightMarker(id) {
            searchResultsGroup.eachLayer(function(marker) {
                marker.setIcon(L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color: #3498db; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                }));
            });
            
            searchResultsGroup.eachLayer(function(marker) {
                if (marker.resultId === id) {
                    marker.setIcon(L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #e74c3c; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white;"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    }));
                    marker.openPopup();
                }
            });
        }
        
        // 获取设施类型的中文名称
        function getFacilityName(type) {
            const names = {
                'hospital': '医疗设施',
                'school': '教育机构',
                'shopping-cart': '购物场所',
                'store': '商业设施',
                'park': '公园绿地',
                'bus': '公交站点',
                'utensils': '餐饮场所',
                'gamepad': '娱乐场所'
            };
            
            return names[type] || '公共设施';
        }
        
        // 清除搜索结果
        function clearSearchResults() {
            searchResultsGroup.clearLayers();
            document.getElementById('searchResults').innerHTML = '<p style="text-align: center; color: #777;"><i class="fas fa-info-circle"></i> 点击上方按钮搜索周边设施</p>';
        }
        
        // 清除路径
        function clearRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            document.getElementById('routeInfo').style.display = 'none';
            document.getElementById('routeDetails').innerHTML = '';
        }
        
        // 规划路线 - 使用高德路径规划API
        function planRoute() {
            clearRoute();
            
            const currentPos = currentMarker.getLatLng();
            const destination = window.currentDestination;
            
            if (!destination) {
                alert('请先选择目的地');
                return;
            }
            
            document.getElementById('routeLoading').style.display = 'block';
            
            // 使用高德路径规划API
            planRouteWithGaode(currentPos, destination);
        }
        
        // 使用高德路径规划API
        function planRouteWithGaode(origin, destination) {
            const mode = currentTransportMode === 'walking' ? 'walk' : 
                        currentTransportMode === 'driving' ? 'drive' : 'ride';
            
            const originStr = `${origin.lng},${origin.lat}`;
            const destStr = `${destination.lng},${destination.lat}`;
            
            const url = `https://restapi.amap.com/v3/direction/${mode}?key=${AMAP_KEY}&origin=${originStr}&destination=${destStr}&output=json`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('routeLoading').style.display = 'none';
                    
                    if (data.status === '1' && data.route && data.route.paths && data.route.paths.length > 0) {
                        const path = data.route.paths[0];
                        const distance = parseInt(path.distance);
                        const duration = parseInt(path.duration);
                        
                        // 显示路线信息
                        displayRouteInfo(distance, duration);
                        displayRouteSteps(path.steps);
                        
                        // 绘制路线
                        drawRouteOnMap(path.steps);
                        
                    } else {
                        // 使用备用方案
                        useFallbackRoute(origin, destination);
                    }
                })
                .catch(error => {
                    console.error('路径规划失败:', error);
                    document.getElementById('routeLoading').style.display = 'none';
                    useFallbackRoute(origin, destination);
                });
        }
        
        // 显示路线信息
        function displayRouteInfo(distance, duration) {
            const distanceKm = (distance / 1000).toFixed(2);
            const durationMin = Math.ceil(duration / 60);
            
            document.getElementById('routeDistance').textContent = distanceKm + '公里';
            document.getElementById('routeTime').textContent = durationMin + '分钟';
            document.getElementById('routeModeText').textContent = getTransportModeText(currentTransportMode);
            document.getElementById('routeInfo').style.display = 'block';
        }
        
        // 显示路线步骤
        function displayRouteSteps(steps) {
            const detailsContainer = document.getElementById('routeDetails');
            let html = '<h5><i class="fas fa-list-ol"></i> 路线指引</h5>';
            
            steps.forEach((step, index) => {
                let icon = 'fas fa-arrow-right';
                const instruction = step.instruction || step.action;
                
                if (instruction.includes('直行')) {
                    icon = 'fas fa-arrow-up';
                } else if (instruction.includes('左转')) {
                    icon = 'fas fa-arrow-left';
                } else if (instruction.includes('右转')) {
                    icon = 'fas fa-arrow-right';
                } else if (instruction.includes('到达')) {
                    icon = 'fas fa-flag-checkered';
                }
                
                html += `
                <div class="route-step">
                    <span class="step-icon"><i class="${icon}"></i></span>
                    <span>${instruction}</span>
                </div>
                `;
            });
            
            detailsContainer.innerHTML = html;
        }
        
        // 在地图上绘制路线
        function drawRouteOnMap(steps) {
            const routeCoordinates = [];
            
            steps.forEach(step => {
                if (step.polyline) {
                    const points = step.polyline.split(';');
                    points.forEach(point => {
                        const coords = point.split(',');
                        if (coords.length === 2) {
                            routeCoordinates.push([parseFloat(coords[1]), parseFloat(coords[0])]);
                        }
                    });
                }
            });
            
            if (routeCoordinates.length > 0) {
                const routeLine = L.polyline(routeCoordinates, {
                    color: '#9b59b6',
                    weight: 5,
                    opacity: 0.7
                }).addTo(map);
                
                // 调整地图视图以显示整个路线
                map.fitBounds(routeLine.getBounds());
            }
        }
        
        // 使用备用路线
        function useFallbackRoute(start, end) {
            const routeLine = L.polyline([
                [start.lat, start.lng],
                [end.lat, end.lng]
            ], {
                color: '#9b59b6',
                weight: 5,
                opacity: 0.7,
                dashArray: '5, 10'
            }).addTo(map);
            
            const distance = calculateDistance(start.lat, start.lng, end.lat, end.lng);
            const time = Math.round(distance / getSpeedByMode(currentTransportMode) * 60);
            
            document.getElementById('routeDistance').textContent = (distance/1000).toFixed(2) + '公里';
            document.getElementById('routeTime').textContent = time + '分钟';
            document.getElementById('routeModeText').textContent = getTransportModeText(currentTransportMode);
            document.getElementById('routeDetails').innerHTML = '<p style="color: #777;"><i class="fas fa-exclamation-triangle"></i> 无法获取详细路线指引，显示直线路径</p>';
            document.getElementById('routeInfo').style.display = 'block';
        }
        
        // 计算两点间距离
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c * 1000;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        // 根据交通方式获取速度
        function getSpeedByMode(mode) {
            switch(mode) {
                case 'driving': return 13.89; // 50 km/h
                case 'cycling': return 4.17;  // 15 km/h
                case 'walking':
                default: return 1.39; // 5 km/h
            }
        }
        
        // 获取交通方式文本
        function getTransportModeText(mode) {
            switch(mode) {
                case 'driving': return '驾车';
                case 'cycling': return '骑行';
                case 'walking':
                default: return '步行';
            }
        }
        
        // 交通方式切换
        document.getElementById('modeWalking').addEventListener('click', function() {
            setTransportMode('walking');
        });
        
        document.getElementById('modeDriving').addEventListener('click', function() {
            setTransportMode('driving');
        });
        
        document.getElementById('modeCycling').addEventListener('click', function() {
            setTransportMode('cycling');
        });
        
        function setTransportMode(mode) {
            currentTransportMode = mode;
            
            document.querySelectorAll('.transport-btn').forEach(btn => {
                btn.classList.remove('active-mode');
            });
            document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active-mode');
            
            if (routingControl) {
                planRoute();
            }
        }
        
        // 清除路线
        document.getElementById('clearRoute').addEventListener('click', function() {
            clearRoute();
        });
        
        // 模拟路径规划
        function simulateRoutePlanning(destinationType) {
            document.getElementById('routeLoading').style.display = 'block';
            document.getElementById('routeInfo').style.display = 'none';
            clearRoute();
            
            const currentPos = currentMarker.getLatLng();
            const destination = generateDestination(currentPos, destinationType);
            window.currentDestination = destination;
            
            planRoute();
        }
        
        // 生成目的地
        function generateDestination(start, type) {
            let latOffset = 0, lngOffset = 0;
            
            switch(type) {
                case 'hospital':
                    latOffset = 0.008;
                    lngOffset = 0.006;
                    break;
                case 'school':
                    latOffset = -0.007;
                    lngOffset = 0.009;
                    break;
                default:
                    latOffset = 0.005;
                    lngOffset = 0.008;
            }
            
            return {
                lat: start.lat + latOffset,
                lng: start.lng + lngOffset,
                name: type === 'hospital' ? '附近医院' : '附近学校',
                type: type
            };
        }
        
        // 绑定搜索按钮事件
        document.getElementById('searchAllBtn').addEventListener('click', function() {
            searchRealFacilities('all');
        });
        
        document.getElementById('searchHospitals').addEventListener('click', function() {
            searchRealFacilities('hospital');
        });
        
        document.getElementById('searchSchools').addEventListener('click', function() {
            searchRealFacilities('school');
        });
        
        document.getElementById('searchShops').addEventListener('click', function() {
            searchRealFacilities('shop');
        });
        
        // 绑定路径规划按钮事件
        document.getElementById('nearestHospital').addEventListener('click', function() {
            simulateRoutePlanning('hospital');
        });
        
        document.getElementById('nearestSchool').addEventListener('click', function() {
            simulateRoutePlanning('school');
        });
        
        // 重置视图
        document.getElementById('resetViewBtn').addEventListener('click', function() {
            map.setView(beijingCenter, 12);
            addCurrentLocationMarker(beijingCenter[0], beijingCenter[1]);
            clearSearchResults();
            clearRoute();
            
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
        });
        
        // 初始加载时显示北京的真实设施
        window.addEventListener('load', function() {
            // 初始搜索北京的设施
            setTimeout(() => {
                searchRealFacilities('all');
            }, 1000);
        });
    </script>
</body>
</html>